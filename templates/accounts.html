{% extends "base.html" %}

{% block title %}Accounts - Links Scraper v2{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ACCOUNTS</h1>
    <div class="btn-group">
        <button class="btn btn-secondary" onclick="refreshAccounts()">REFRESH</button>
        <a href="{{ url_for('add_account_page') }}" class="btn btn-primary">ADD ACCOUNT</a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="grid grid-3">
            <div class="form-group">
                <label class="form-label">PLATFORM</label>
                <select class="form-input" id="platform-filter">
                    <option value="">ALL PLATFORMS</option>
                    <option value="instagram">INSTAGRAM</option>
                    <option value="tiktok">TIKTOK</option>
                    <option value="x">X/TWITTER</option>
                    <option value="facebook">FACEBOOK</option>
                    <option value="youtube">YOUTUBE</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">STATUS</label>
                <select class="form-input" id="status-filter">
                    <option value="">ALL STATUSES</option>
                    <option value="active">ACTIVE</option>
                    <option value="paused">PAUSED</option>
                    <option value="error">ERROR</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">SEARCH</label>
                <input type="text" class="form-input" id="search-filter" placeholder="SEARCH USERNAME...">
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header flex flex-between">
        <span>ALL ACCOUNTS</span>
        <span id="accounts-count">LOADING...</span>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>ACCOUNT</th>
                <th>PLATFORM</th>
                <th>STATUS</th>
                <th>VIDEOS</th>
                <th>LAST CHECKED</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody id="accounts-table">
            <tr>
                <td colspan="6" class="text-center">
                    <span class="loading"></span> LOADING ACCOUNTS...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #000000; max-width: 500px; width: 90%;">
        <div class="card-header">CONFIRM DELETE</div>
        <div class="card-body">
            <p style="margin-bottom: 20px;">ARE YOU SURE YOU WANT TO DELETE THIS ACCOUNT? THIS WILL PERMANENTLY DELETE ALL VIDEO LINKS.</p>
            <div id="delete-account-info" style="margin-bottom: 30px;"></div>
            <div class="btn-group" style="width: 100%;">
                <button class="btn btn-danger" id="confirm-delete" style="flex: 1;">DELETE</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">CANCEL</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allAccounts = [];
let accountToDelete = null;

function refreshAccounts() {
    fetch('/api/accounts')
        .then(response => response.json())
        .then(accounts => {
            allAccounts = accounts;
            applyFilters();
        })
        .catch(error => {
            console.error('Error loading accounts:', error);
            showAlert('ERROR LOADING ACCOUNTS', 'error');
        });
}

function applyFilters() {
    const platform = document.getElementById('platform-filter').value;
    const status = document.getElementById('status-filter').value;
    const search = document.getElementById('search-filter').value.toLowerCase();
    
    const filtered = allAccounts.filter(account => {
        const matchesPlatform = !platform || account.platform === platform;
        const matchesStatus = !status || account.status === status;
        const matchesSearch = !search || account.username.toLowerCase().includes(search);
        return matchesPlatform && matchesStatus && matchesSearch;
    });
    
    updateAccountsTable(filtered);
    document.getElementById('accounts-count').textContent = 
        `${filtered.length} OF ${allAccounts.length} ACCOUNTS`;
}

function updateAccountsTable(accounts) {
    const tbody = document.getElementById('accounts-table');
    
    if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">NO ACCOUNTS FOUND</td></tr>';
        return;
    }
    
    let html = '';
    accounts.forEach(account => {
        const statusBadge = getStatusBadge(account.status);
        const platformBadge = `<span class="badge badge-info">${account.platform.toUpperCase()}</span>`;
        
        html += `
            <tr>
                <td>
                    <div style="font-weight: 500;">${account.username}</div>
                    <div style="font-size: 12px; color: #000000; margin-top: 4px;">${account.url}</div>
                </td>
                <td>${platformBadge}</td>
                <td>${statusBadge}</td>
                <td><span class="badge badge-info">${account.video_count}</span></td>
                <td style="font-size: 12px;">${formatDate(account.last_checked)}</td>
                <td>
                    <div class="btn-group">
                        <a href="/account/${account.id}/links" class="btn btn-secondary" style="font-size: 11px; padding: 8px 12px;">LINKS</a>
                        <button onclick="toggleStatus(${account.id})" class="btn btn-secondary" style="font-size: 11px; padding: 8px 12px;">
                            ${account.status === 'active' ? 'PAUSE' : 'ACTIVATE'}
                        </button>
                        <button onclick="showDeleteModal(${account.id})" class="btn btn-danger" style="font-size: 11px; padding: 8px 12px;">DELETE</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function getStatusBadge(status) {
    const classes = {
        'active': 'badge-success',
        'paused': 'badge-warning',
        'error': 'badge-danger'
    };
    return `<span class="badge ${classes[status] || 'badge-info'}">${status.toUpperCase()}</span>`;
}

function toggleStatus(accountId) {
    fetch(`/api/accounts/${accountId}/toggle`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            const index = allAccounts.findIndex(acc => acc.id === accountId);
            if (index !== -1) {
                allAccounts[index] = data;
                applyFilters();
            }
            showAlert(`ACCOUNT STATUS UPDATED TO: ${data.status.toUpperCase()}`);
        })
        .catch(error => {
            showAlert('ERROR UPDATING ACCOUNT STATUS', 'error');
        });
}

function showDeleteModal(accountId) {
    const account = allAccounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    accountToDelete = account;
    document.getElementById('delete-account-info').innerHTML = `
        <div style="padding: 20px; background: #ffffff; border: 1px solid #000000;">
            <strong>${account.username}</strong><br>
            <span style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">${account.platform} â€¢ ${account.video_count} VIDEOS</span>
        </div>
    `;
    document.getElementById('delete-modal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
    accountToDelete = null;
}

document.getElementById('confirm-delete').addEventListener('click', function() {
    if (!accountToDelete) return;
    
    this.disabled = true;
    this.innerHTML = '<span class="loading"></span> DELETING...';
    
    fetch(`/api/accounts/${accountToDelete.id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            showAlert(`ACCOUNT DELETED: ${accountToDelete.username.toUpperCase()}`);
            allAccounts = allAccounts.filter(acc => acc.id !== accountToDelete.id);
            applyFilters();
            closeDeleteModal();
        })
        .catch(error => {
            showAlert('ERROR DELETING ACCOUNT', 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = 'DELETE';
        });
});

document.getElementById('platform-filter').addEventListener('change', applyFilters);
document.getElementById('status-filter').addEventListener('change', applyFilters);
document.getElementById('search-filter').addEventListener('input', applyFilters);

document.addEventListener('DOMContentLoaded', refreshAccounts);
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Dashboard - Links Scraper v2{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">DASHBOARD</h1>
    <div class="btn-group">
        <button class="btn btn-secondary" onclick="refreshData()">REFRESH</button>
        <button class="btn btn-primary" id="scheduler-btn" onclick="toggleScheduler()">LOADING...</button>
    </div>
</div>

<div class="grid grid-4 mb-4">
    <div class="card">
        <div class="stat-card">
            <div class="stat-number" style="color: #1e3a8a;" id="total-accounts">0</div>
            <div class="stat-label">TOTAL ACCOUNTS</div>
        </div>
    </div>
    <div class="card">
        <div class="stat-card">
            <div class="stat-number" style="color: #1e3a8a;" id="active-accounts">0</div>
            <div class="stat-label">ACTIVE ACCOUNTS</div>
        </div>
    </div>
    <div class="card">
        <div class="stat-card">
            <div class="stat-number" style="color: #000000;" id="total-videos">0</div>
            <div class="stat-label">TOTAL VIDEOS</div>
        </div>
    </div>
    <div class="card">
        <div class="stat-card">
            <div class="stat-number" style="color: #000000;" id="scheduler-status">UNKNOWN</div>
            <div class="stat-label">SCHEDULER STATUS</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">RECENT ACCOUNTS</div>
    <table class="table" id="accounts-table">
        <thead>
            <tr>
                <th>ACCOUNT</th>
                <th>PLATFORM</th>
                <th>STATUS</th>
                <th>VIDEOS</th>
                <th>LAST CHECKED</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="6" class="text-center">
                    <span class="loading"></span> LOADING ACCOUNTS...
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
let schedulerRunning = false;

function refreshData() {
    loadAccounts();
    loadSchedulerStatus();
}

function loadAccounts() {
    fetch('/api/accounts')
        .then(response => response.json())
        .then(accounts => {
            updateStats(accounts);
            updateAccountsTable(accounts);
        })
        .catch(error => {
            console.error('Error loading accounts:', error);
            showAlert('ERROR LOADING ACCOUNTS', 'error');
        });
}

function updateStats(accounts) {
    document.getElementById('total-accounts').textContent = accounts.length;
    document.getElementById('active-accounts').textContent = 
        accounts.filter(acc => acc.status === 'active').length;
    document.getElementById('total-videos').textContent = 
        accounts.reduce((sum, acc) => sum + acc.video_count, 0);
}

function updateAccountsTable(accounts) {
    const tbody = document.querySelector('#accounts-table tbody');
    
    if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">NO ACCOUNTS FOUND</td></tr>';
        return;
    }
    
    let html = '';
    accounts.slice(0, 10).forEach(account => {
        const statusBadge = getStatusBadge(account.status);
        const platformBadge = `<span class="badge badge-info">${account.platform.toUpperCase()}</span>`;
        
        html += `
            <tr>
                <td style="font-weight: 500;">${account.username}</td>
                <td>${platformBadge}</td>
                <td>${statusBadge}</td>
                <td><span class="badge badge-info">${account.video_count}</span></td>
                <td>${formatDate(account.last_checked)}</td>
                <td>
                    <a href="/account/${account.id}/links" class="btn btn-secondary" style="min-width: 100px; height: 36px; font-size: 12px;">VIEW LINKS</a>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function getStatusBadge(status) {
    const classes = {
        'active': 'badge-success',
        'paused': 'badge-warning', 
        'error': 'badge-danger'
    };
    return `<span class="badge ${classes[status] || 'badge-info'}">${status.toUpperCase()}</span>`;
}

function loadSchedulerStatus() {
    fetch('/api/scheduler/status')
        .then(response => response.json())
        .then(data => {
            schedulerRunning = data.running;
            updateSchedulerUI();
        })
        .catch(error => {
            document.getElementById('scheduler-status').textContent = 'ERROR';
            document.getElementById('scheduler-btn').textContent = 'ERROR';
        });
}

function updateSchedulerUI() {
    const statusEl = document.getElementById('scheduler-status');
    const btnEl = document.getElementById('scheduler-btn');
    
    if (schedulerRunning) {
        statusEl.textContent = 'RUNNING';
        statusEl.style.color = '#1e3a8a';
        btnEl.textContent = 'STOP SCHEDULER';
        btnEl.className = 'btn btn-danger';
    } else {
        statusEl.textContent = 'STOPPED';
        statusEl.style.color = '#000000';
        btnEl.textContent = 'START SCHEDULER';
        btnEl.className = 'btn btn-primary';
    }
}

function toggleScheduler() {
    const endpoint = schedulerRunning ? '/api/scheduler/stop' : '/api/scheduler/start';
    
    fetch(endpoint, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showAlert(data.message.toUpperCase());
                loadSchedulerStatus();
            } else {
                showAlert((data.error || 'ERROR').toUpperCase(), 'error');
            }
        })
        .catch(error => {
            showAlert('ERROR TOGGLING SCHEDULER', 'error');
        });
}

document.addEventListener('DOMContentLoaded', refreshData);
setInterval(refreshData, 30000);
</script>
{% endblock %}